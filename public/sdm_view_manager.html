<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>

    <link rel="stylesheet" href="/style.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        .btn-outline-secondary {
           margin-top: 20px; 
           
       }
       .content{
           margin: 50px;
       }
       .center-image{
           margin:auto;
           margin-top: 50px;
           display: block;
       }
       .btn-primary{
           margin:auto;
           display: block;
       }
       .btn-large {
           border-radius: 50%; /* 將按鈕設置為圓形 */
           font-size: 20px;
           padding: 10px 15px;
       }
     .btn-circle {
           border-radius: 50%; /* 將按鈕設置為圓形 */
           font-size: 20px; /* 調整按鈕內字體大小 */
       }
       </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg " id="nav-color">
        <a class="navbar-brand" href="test.html" style="font-weight: bold">
          <img src="medical_icon.png" alt="Logo" width="40" height="40"> 醫療小幫手</a>
        <button
          class="navbar-toggler"
          type="button"
          data-toggle="collapse"
          data-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="test.html" style="font-weight: bold">
                <img src="home_icon.png" alt="Logo" width="25" height="25"> 首頁</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="medical_form.html" style="font-weight: bold">
                <img src="leaflet.png" alt="Logo" width="25" height="25"> 手術問卷</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="personal_medicalcare.html" style="font-weight: bold">
                <img src="personal_medical.png" alt="Logo" width="30" height="30"> 個人醫療</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="user_info_modifiy.html" style="font-weight: bold">
                  <img src="modify.png" alt="Logo" width="28" height="28"> 用戶基本資料修改</a>
              </li>
            <li class="nav-item">
                <a class="nav-link" href="user_feedback.html" style="font-weight: bold">
                  <img src="reply2.png" alt="Logo" width="30" height="30"> 回饋</a>
            </li>  
            <li class="nav-item">
              <a class="nav-link" id="sdm" href="sdm.html" style="font-weight: bold">
                <img src="sdmicon.png" alt="Logo" width="25" height="27"> 醫病共享決策</a>
          </li> 
          </ul>
          <div class="ms-auto">
            <a class="btn btn-light"  id="logout-button">登出</a>
          </div>
          <div id="userNameDisplay" class="user-name-display"></div>

        </div>
    </nav>
    <div class="container">
    <nav aria-label="breadcrumb" class="navbar">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="sdm_manager.html">醫病共享決策</a></li>
            <li class="breadcrumb-item"></a>醫共享決策全體作答內容</li>
            <li class="breadcrumb-item" id="breadcrumbItem"></li>
        </ol>

        <!-- 字體調整功能 -->
        <div class="font-size-adjustment">
          <button onclick="resetFontSize()">恢復</button>
            <label for="font-size">字體大小：</label>
            <button onclick="decreaseFontSize()" class="btn-circle">小</button>
            <input type="range" id="font-size" min="10" max="30" value="16" onchange="changeFontSize(this.value)">
            <button onclick="increaseFontSize()" class="btn-large">大</button>
          </div>
      </nav>
        <h2>現有的填寫紀錄如下</h2>
        <button class="btn btn-outline-secondary btn-lg" onclick="showTable(1)">醫療方式的考量</button>
        <button class="btn btn-outline-secondary btn-lg" onclick="showTable(2)">醫療資訊的認知</button>
        <button class="btn btn-outline-secondary btn-lg" onclick="showTable(3)">醫療方式的確認</button>
        <div id="table1" style="display: none;">
        <table class="table">
            <!-- 醫療方式的考量 -->
            <thead>
                <tr>
                    <th scope="col">User Id</th>
                    <th scope="col">SDM Title</th>
                    <th scope="col">SDM Id</th>
                    <th scope="col">Ch2_1_A</th>
                    <th scope="col">Ch2_2_A</th>
                    <th scope="col">Ch2_3_A</th>
                    <th scope="col">Ch2_4_A</th>
                    <th scope="col">Ch2_5_A</th>
                    <th scope="col">重新作答</th>
                    <th scope="col">表單狀態</th>

                </tr>
            </thead>
            <tbody id="table1Body"></tbody>
        </table>
        <button onclick="saveAllStatuses()">保存</button>
        </div>
        <div id="table2" style="display: none;">
            <table class="table">
                <!-- 醫療資訊的認知 -->
                <thead>
                    <tr>
                        <th scope="col">User Id</th>
                        <th scope="col">SDM Title</th>
                        <th scope="col">SDM Id</th>
                        <th scope="col">Ch3_1_A</th>
                        <th scope="col">Ch3_2_A</th>
                        <th scope="col">Ch3_3_A</th>
                        <th scope="col">Ch3_4_A</th>
                        <th scope="col">Ch3_5_A</th>
                        <th scope="col">重新作答</th>
                        <th scope="col">表單狀態</th>
                    </tr>
                </thead>
                <tbody id="table2Body"></tbody>
              </table>
              <button onclick="saveAllStatuses()">保存</button>
        </div>
        <div id="table3" style="display: none;">
            <table class="table">
                <!-- 醫療方式的確認 -->
                <thead>
                    <tr>
                        <th scope="col">User Id</th>
                        <th scope="col">SDM Title</th>
                        <th scope="col">SDM Id</th>
                        <th scope="col">Ch4_1_A</th>
                        <th scope="col">Ch4_2_A</th>
                        <th scope="col">重新作答</th>
                        <th scope="col">表單狀態</th>
                    </tr>
                </thead>
                <tbody id="table3Body"></tbody>
            </table>
            <button onclick="saveAllStatuses()">保存</button>
        </div>
    </div>
   </body>
</html>

<script>
  const admin = localStorage.getItem('admin'); // 去得lacalStorage裡的admin資訊
  const user = JSON.parse(localStorage.getItem('user')); // 去得lacalStorage裡的user資訊
  const logoutButton = document.getElementById('logout-button');
    logoutButton.addEventListener('click', function() {
    // 檢查localStorage中是否有admin資訊
    if (localStorage.getItem('admin')) {
      localStorage.removeItem('admin'); // 移除管理員資訊
      window.location.href = 'manager_login.html'; // 跳轉到管理員登入頁面
    } else if (localStorage.getItem('user')) {     // 檢查localStorage中是否有user資訊
      localStorage.removeItem('user'); // 移除使用者資訊
      window.location.href = 'user_login.html'; // 跳轉到使用者登入頁面
    }
  });
  function changeFontSize(size) {
            var elements = document.querySelectorAll("*"); // 選擇所有元素
            elements.forEach(function(element) {
              document.documentElement.style.fontSize = size + "px"; // 設置每個元素的字體大小
            });
        }
        //加大字體
        function increaseFontSize() {
        var fontSizeSlider = document.getElementById('font-size');
        var newSize = parseInt(fontSizeSlider.value) + 1;
        if (newSize <= parseInt(fontSizeSlider.max)) {
            fontSizeSlider.value = newSize;
            changeFontSize(newSize);
        }
    }

    // 减小字體
    function decreaseFontSize() {
        var fontSizeSlider = document.getElementById('font-size');
        var newSize = parseInt(fontSizeSlider.value) - 1;
        if (newSize >= parseInt(fontSizeSlider.min)) {
            fontSizeSlider.value = newSize;
            changeFontSize(newSize);
        }
    }
        // 恢復預設字體大小函數
        function resetFontSize() {
            var elements = document.querySelectorAll("*"); // 選擇所有元素
            elements.forEach(function(element) {
                element.style.fontSize = ""; // 清除直接設定的字體大小，使其回復到預設值
            });

            // 重置滑動桿的值為預設值
            var fontSizeSlider = document.getElementById('font-size');
            fontSizeSlider.value = 16;

            // 重置導航條樣式
            var breadcrumb = document.querySelector(".breadcrumb");
            breadcrumb.classList.remove("active");
        }
    
  function showTable(tableNumber) {
    const breadcrumbItem = document.getElementById('breadcrumbItem');
    const params = new URLSearchParams(window.location.search);
    const sdmId = params.get('SDM_id'); 
    fetch(`/sdm_manager?SDM_id=${sdmId}`)
                .then(response => response.json())
                .then(data => {
                    if (tableNumber === 1) {
                        fillTable(data.table1);
                    } else if (tableNumber === 2) {
                        fillTable(data.table2);
                    } else if (tableNumber === 3) {
                        fillTable(data.table3);
                 }
                })
                .catch(error => console.error('Error:', error));

            switch (tableNumber) {
                case 1:
                    breadcrumbItem.textContent = '醫療方式的考量';
                    break;
                case 2:
                    breadcrumbItem.textContent = '醫療資訊的認知';
                    break;
                case 3:
                    breadcrumbItem.textContent = '醫療方式的確認';
                    break;
                default:
                    breadcrumbItem.textContent = '醫共享決策作答內容';
            }
            // 隐藏所有表格
            document.getElementById('table1').style.display = 'none';
            document.getElementById('table2').style.display = 'none';
            document.getElementById('table3').style.display = 'none';

            // 显示所选表格
            document.getElementById(`table${tableNumber}`).style.display = 'block';
}

// 获取数据并显示在 HTML 页面中
function getDataAndDisplay() {
    const params = new URLSearchParams(window.location.search);
    const sdmId = params.get('SDM_id'); 

    // 发送请求
    fetch('/get-sdm-manager', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ SDM_id: sdmId })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to fetch data');
        }
        return response.json();
    })
    .then(data => {
        // 处理从后端获取的数据
        const table1Data = data.table1;
        const table2Data = data.table2;
        const table3Data = data.table3;

        // 将数据显示在 HTML 页面中
        displayDataInHTML(table1Data, table2Data, table3Data);
    })
    .catch(error => {
        console.error('Error fetching data:', error);
    });
}



// 将数据显示在 HTML 页面中
function displayDataInHTML(table1Data, table2Data, table3Data) {
    // 显示第一个表格的数据
    const table1Body = document.getElementById('table1Body');
    table1Data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row.user_id}</td>
            <td>${row.SDM_tittle}</td>
            <td>${row.SDM_id}</td>
            <td>${row.Ch2_1_A}</td>
            <td>${row.Ch2_2_A}</td>
            <td>${row.Ch2_3_A}</td>
            <td>${row.Ch2_4_A}</td>
            <td>${row.Ch2_5_A}</td>
            <td><button onclick="notifyUserToRetake('${row.user_id}', '${row.SDM_id}')">重新作答</button></td>
            <td>
                <select onchange="updateFormStatus(${row.SDM_id}, 'ch2', this.value)">
                    <option value="未處理" ${row.form_status === '未處理' ? 'selected' : ''}>未處理</option>
                    <option value="處理中" ${row.form_status === '處理中' ? 'selected' : ''}>處理中</option>
                    <option value="已完成" ${row.form_status === '已完成' ? 'selected' : ''}>已完成</option>
                    <option value="作廢" ${row.form_status === '作廢' ? 'selected' : ''}>作廢</option>
                </select>
            </td>
        `;
        table1Body.appendChild(tr);
    });

    // 显示第二个表格的数据
    const table2Body = document.getElementById('table2Body');
    table2Data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row.user_id}</td>
            <td>${row.SDM_tittle}</td>
            <td>${row.SDM_id}</td>
            <td>${row.Ch3_1_A}</td>
            <td>${row.Ch3_2_A}</td>
            <td>${row.Ch3_3_A}</td>
            <td>${row.Ch3_4_A}</td>
            <td>${row.Ch3_5_A}</td>
            <td><button onclick="notifyUserToRetake('${row.user_id}', '${row.SDM_id}')">重新作答</button></td>
            <td>
                <select onchange="updateFormStatus(${row.SDM_id}, 'ch3', this.value)">
                    <option value="未處理" ${row.form_status === '未處理' ? 'selected' : ''}>未處理</option>
                    <option value="處理中" ${row.form_status === '處理中' ? 'selected' : ''}>處理中</option>
                    <option value="已完成" ${row.form_status === '已完成' ? 'selected' : ''}>已完成</option>
                    <option value="作廢" ${row.form_status === '作廢' ? 'selected' : ''}>作廢</option>
                </select>
            </td>
        `;
        table2Body.appendChild(tr);
    });

    // 显示第三个表格的数据
    const table3Body = document.getElementById('table3Body');
    table3Data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row.user_id}</td>
            <td>${row.SDM_tittle}</td>
            <td>${row.SDM_id}</td>
            <td>${row.Ch4_1_A}</td>
            <td>${row.Ch4_2_A}</td>
            <td><button onclick="notifyUserToRetake('${row.user_id}', '${row.SDM_id}')">重新作答</button></td>
            <td>
                <select onchange="updateFormStatus(${row.SDM_id}, 'ch4', this.value)">
                    <option value="未處理" ${row.form_status === '未處理' ? 'selected' : ''}>未處理</option>
                    <option value="處理中" ${row.form_status === '處理中' ? 'selected' : ''}>處理中</option>
                    <option value="已完成" ${row.form_status === '已完成' ? 'selected' : ''}>已完成</option>
                    <option value="作廢" ${row.form_status === '作廢' ? 'selected' : ''}>作廢</option>

                </select>
            </td>
        `;
        table3Body.appendChild(tr);
    });
}

function notifyUserToRetake(userId, sdmId) {
    fetch('/notify-retake', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ user_id: userId, SDM_id: sdmId, })
    })
    .then(response => {
        if (response.ok) {
            alert(`通知已发送给用户 ${userId}，需要重新作答 SDM ${sdmId}`);
            location.reload();
        } else {
            alert('發送通知出現錯誤');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('連結出錯');
    });
}

function saveAllStatuses() {
            const statuses = [];
            document.querySelectorAll('tbody tr').forEach(row => {
                const sdmId = row.children[2].textContent;
                const userId = row.children[0].textContent;
                const formType = row.parentElement.id === 'table1Body' ? 'ch2' :
                                 row.parentElement.id === 'table2Body' ? 'ch3' : 'ch4';
                const status = row.querySelector('select').value;
                statuses.push({ SDM_id: sdmId, user_id: userId, formType: formType, status: status });
            });

            fetch('/update-all-form-statuses', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ statuses: statuses })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('所有表單狀態更新成功');
                } else {
                    console.error('更新表單狀態時發生錯誤');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
function updateFormStatus(sdmId, newStatus) {
    fetch('/update-form-status', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ SDM_id: sdmId, formType: formType, status: newStatus })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('表单状态更新成功');
        } else {
            console.error('表单状态更新失败');
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}


// 在页面加载完成后调用函数获取并显示数据
window.addEventListener('DOMContentLoaded', () => {
    getDataAndDisplay();
});


</script>

 
